/*
 * buzzer.cpp
 *
 *  Created on: Feb 12, 2024
 *      Author: mmaakkyyii
 */
#include "tim.h"
#include "buzzer.h"


Buzzer::Buzzer(){

}
void Buzzer::Init(){
	HAL_TIM_PWM_Start(&htim12, TIM_CHANNEL_1);

}
void Buzzer::Update(){
	timer_ms_++;
	if(timer_ms_>set_time_ms_)Off();
}

void Buzzer::On(float f){
    uint32_t timerClock = HAL_RCC_GetPCLK1Freq();  // タイマ�????????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��のクロ???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?ク周波数を取???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?
    uint32_t prescaler = htim12.Init.Prescaler;     // 現在のプリスケーラ値を取???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?
    uint32_t period = (timerClock / (prescaler + 1)) / f - 1;

    __HAL_TIM_SET_AUTORELOAD(&htim12, period);
    __HAL_TIM_SET_COMPARE(&htim12, TIM_CHANNEL_1, period / 5);  // 50% duty cycle

}
void Buzzer::Off(){
	__HAL_TIM_SET_COMPARE(&htim12, TIM_CHANNEL_1, 0);
}
void Buzzer::SetFrequency(float f, int time_ms){
	set_time_ms_=time_ms;
	timer_ms_=0;

    uint32_t timerClock = HAL_RCC_GetPCLK1Freq();  // タイマ�????????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��のクロ???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?ク周波数を取???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?
    uint32_t prescaler = htim12.Init.Prescaler;     // 現在のプリスケーラ値を取???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?
    uint32_t period = (timerClock / (prescaler + 1)) / f - 1;

    __HAL_TIM_SET_AUTORELOAD(&htim12, period);
    __HAL_TIM_SET_COMPARE(&htim12, TIM_CHANNEL_1, period / 3);  // 50% duty cycle

}
void setBuzzerFrequency(float frequency) {
	if(frequency<0){
		__HAL_TIM_SET_COMPARE(&htim12, TIM_CHANNEL_1, 0);
	}
    uint32_t timerClock = HAL_RCC_GetPCLK1Freq();  // タイマ�????????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��のクロ???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?ク周波数を取???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?
    uint32_t prescaler = htim12.Init.Prescaler;     // 現在のプリスケーラ値を取???????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��??????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?????��?��??��?��???��?��??��?��????��?��??��?��???��?��??��?��?
    uint32_t period = (timerClock / (prescaler + 1)) / frequency - 1;

    __HAL_TIM_SET_AUTORELOAD(&htim12, period);
    __HAL_TIM_SET_COMPARE(&htim12, TIM_CHANNEL_1, period / 5);  // 50% duty cycle
}


